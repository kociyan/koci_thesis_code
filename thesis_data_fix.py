# -*- coding: utf-8 -*-
"""Thesis_data_fix.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1JJDK9Iq4C-Xq5Oq2Q9gNsQowUzzAwzLB
"""

!pip install pandas openpyxl xlrd
import pandas as pd
from google.colab import files

# ====== äº¤äº’ä¸Šä¼  ======
print("è¯·ä¸Šä¼ æ‚¨çš„æ–‡ä»¶ï¼ˆæ”¯æŒ.xls/.xlsx/.csvï¼‰ï¼š")
uploaded = files.upload()
file_name = next(iter(uploaded))

# ====== æ™ºèƒ½æ ¼å¼è¯†åˆ« ======
try:
    # å°è¯•ä½œä¸ºExcelè¯»å–
    df = pd.read_excel(file_name, engine=None)  # è‡ªåŠ¨é€‰æ‹©å¼•æ“
except:
    # å¤±è´¥æ—¶å°è¯•ä½œä¸ºCSVè¯»å–
    try:
        df = pd.read_csv(file_name, encoding_errors='ignore')
    except Exception as e:
        print(f"æ— æ³•è¯†åˆ«æ–‡ä»¶æ ¼å¼ï¼š{str(e)}")
        raise

# ====== åç»­å¤„ç†ä¿æŒä¸å˜ ======
df.insert(
    loc=df.columns.get_loc('title') + 1,
    column='fixed_PublishedAt',
    value=df['title'].str.extract(r'(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}Z)', expand=False)
)
df.drop('title', axis=1, inplace=True)

# ä¿å­˜å¹¶ä¸‹è½½
output_name = f"processed_{file_name.split('.')[0]}.xlsx"
df.to_excel(output_name, index=False)
files.download(output_name)



from google.colab import files
import pandas as pd
from io import BytesIO
import os
import time

def merge_files_safely():
    print("ğŸ“‚ è¯·é€‰æ‹©è¦åˆå¹¶çš„æ–‡ä»¶ï¼ˆæ”¯æŒ .xlsx / .xls / .csvï¼‰ï¼š")
    uploaded = files.upload()

    merged = pd.DataFrame()

    for name, file in uploaded.items():
        ext = os.path.splitext(name)[1].lower()
        try:
            if ext in ['.xlsx', '.xls']:
                df = pd.read_excel(BytesIO(file))
            elif ext == '.csv':
                try:
                    df = pd.read_csv(BytesIO(file))
                except:
                    df = pd.read_csv(BytesIO(file), encoding='gbk')
            else:
                print(f"âš ï¸ è·³è¿‡ä¸æ”¯æŒçš„æ–‡ä»¶ï¼š{name}")
                continue

            merged = pd.concat([merged, df], ignore_index=True)
            print(f"âœ… å·²åˆå¹¶ï¼š{name}ï¼ˆ{len(df)} è¡Œï¼‰")
        except Exception as e:
            print(f"âŒ è¯»å–å¤±è´¥ï¼š{name} - {e}")

    if merged.empty:
        print("âš ï¸ æ²¡æœ‰æˆåŠŸåˆå¹¶ä»»ä½•æ–‡ä»¶ã€‚")
        return

    filename = f"åˆå¹¶ç»“æœ_{time.strftime('%Y%m%d_%H%M%S')}.xlsx"
    merged.to_excel(filename, index=False)
    print(f"\nğŸ‰ åˆå¹¶å®Œæˆï¼å…± {len(merged)} è¡Œï¼Œ{len(merged.columns)} åˆ—")
    print("ğŸ“¥ æ­£åœ¨ä¸‹è½½åˆå¹¶ç»“æœæ–‡ä»¶...")
    files.download(filename)

merge_files_safely()

from google.colab import files
import pandas as pd
from io import BytesIO
import os

def process_column_safely():
    print("ğŸ“‚ è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶ï¼ˆä»…æ”¯æŒ 1 ä¸ª .xlsx / .xls / .csvï¼‰ï¼š")
    uploaded = files.upload()

    if not uploaded:
        print("âš ï¸ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶")
        return

    # åªå¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
    filename, file_data = next(iter(uploaded.items()))
    ext = os.path.splitext(filename)[1].lower()

    try:
        # è¯»å–æ–‡ä»¶
        if ext in ['.xlsx', '.xls']:
            df = pd.read_excel(BytesIO(file_data))
        elif ext == '.csv':
            try:
                df = pd.read_csv(BytesIO(file_data))
            except UnicodeDecodeError:
                df = pd.read_csv(BytesIO(file_data), encoding='gbk')
        else:
            raise ValueError("âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼")

        # æ£€æŸ¥å¿…è¦åˆ—
        required_cols = ['Same_video_group', 'region']
        missing_cols = [col for col in required_cols if col not in df.columns]
        if missing_cols:
            raise KeyError(f"âŒ ç¼ºå°‘å¿…è¦åˆ—ï¼š{', '.join(missing_cols)}")

        # æ˜¾ç¤ºåŸå§‹é¢„è§ˆ
        print("ğŸ“„ åŸå§‹æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰ï¼š")
        display(df.head())

        # å¤„ç†åˆ—
        df['Same_video_group'] = df['region'].astype(str) + df['Same_video_group'].astype(str)

        # æ˜¾ç¤ºå¤„ç†åé¢„è§ˆ
        print("\nâœ¨ å¤„ç†åçš„æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰ï¼š")
        display(df.head())

        # ä¿å­˜å¹¶ä¸‹è½½
        new_filename = f"processed_{filename}"
        if ext in ['.xlsx', '.xls']:
            df.to_excel(new_filename, index=False)
        else:
            df.to_csv(new_filename, index=False)
        print("ğŸ“¥ æ­£åœ¨ä¸‹è½½å¤„ç†åçš„æ–‡ä»¶...")
        files.download(new_filename)

    except Exception as e:
        print(f"âŒ å¤„ç†å¤±è´¥ï¼š{str(e)}")

# è¿è¡Œç¨‹åº
process_column_safely()

from google.colab import files
import pandas as pd
from io import BytesIO
import os

def process_column_safely():
    print("ğŸ“‚ è¯·é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶ï¼ˆä»…æ”¯æŒ 1 ä¸ª .xlsx / .xls / .csvï¼‰ï¼š")
    uploaded = files.upload()

    if not uploaded:
        print("âš ï¸ æ²¡æœ‰é€‰æ‹©æ–‡ä»¶")
        return

    # åªå¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
    filename, file_data = next(iter(uploaded.items()))
    ext = os.path.splitext(filename)[1].lower()

    try:
        # è¯»å–æ–‡ä»¶
        if ext in ['.xlsx', '.xls']:
            df = pd.read_excel(BytesIO(file_data))
        elif ext == '.csv':
            try:
                df = pd.read_csv(BytesIO(file_data))
            except UnicodeDecodeError:
                df = pd.read_csv(BytesIO(file_data), encoding='gbk')
        else:
            raise ValueError("âŒ ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼")

        # æ£€æŸ¥å¿…è¦åˆ—
        required_cols = ['Same_video_group', 'region']
        missing_cols = [col for col in required_cols if col not in df.columns]
        if missing_cols:
            raise KeyError(f"âŒ ç¼ºå°‘å¿…è¦åˆ—ï¼š{', '.join(missing_cols)}")

        # æ˜¾ç¤ºåŸå§‹é¢„è§ˆ
        print("ğŸ“„ åŸå§‹æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰ï¼š")
        display(df.head())

        # å¤„ç†åˆ—
        df['Same_video_group'] = df['region'].astype(str) + df['Same_video_group'].astype(str)

        # æ˜¾ç¤ºå¤„ç†åé¢„è§ˆ
        print("\nâœ¨ å¤„ç†åçš„æ•°æ®é¢„è§ˆï¼ˆå‰5è¡Œï¼‰ï¼š")
        display(df.head())

        # ä¿å­˜å¹¶ä¸‹è½½
        new_filename = f"processed_{filename}"
        if ext in ['.xlsx', '.xls']:
            df.to_excel(new_filename, index=False)
        else:
            df.to_csv(new_filename, index=False)
        print("ğŸ“¥ æ­£åœ¨ä¸‹è½½å¤„ç†åçš„æ–‡ä»¶...")
        files.download(new_filename)

    except Exception as e:
        print(f"âŒ å¤„ç†å¤±è´¥ï¼š{str(e)}")

# è¿è¡Œç¨‹åº
process_column_safely()